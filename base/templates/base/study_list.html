{% extends 'base/base.html' %}

{% block title %}Clinical Studies - NEST 2.0{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'base:dashboard' %}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Clinical Studies
                    </li>
                </ol>
            </nav>
            <h1 class="page-title">Clinical Studies Overview</h1>
            <p class="page-subtitle">
                <i class="fas fa-flask"></i> Comprehensive view of all active clinical research studies
                <span class="ms-3 text-muted">
                    <small>{{ studies|length }} Active Studies</small>
                </span>
            </p>
        </div>
        <div class="mt-3 mt-md-0">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudyModal">
                <i class="fas fa-plus me-2"></i>Add New Study
            </button>
        </div>
    </div>
</div>

<!-- Quick Statistics -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card" style="border-left-color: #0d6efd;">
            <div class="card-body position-relative">
                <div class="metric-label">
                    <i class="fas fa-flask me-1"></i> Total Studies
                </div>
                <div class="metric-value">{{ studies|length|default:0 }}</div>
                <div class="mt-2">
                    <small class="text-muted">Active research programs</small>
                </div>
                <i class="fas fa-flask metric-icon" style="color: #0d6efd;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card" style="border-left-color: #198754;">
            <div class="card-body position-relative">
                <div class="metric-label">
                    <i class="fas fa-hospital-alt me-1"></i> Total Research Sites
                </div>
                <div class="metric-value" style="color: #198754;">
                    {{ total_sites|default:0 }}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Across all studies</small>
                </div>
                <i class="fas fa-hospital-alt metric-icon" style="color: #198754;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card" style="border-left-color: #0dcaf0;">
            <div class="card-body position-relative">
                <div class="metric-label">
                    <i class="fas fa-users me-1"></i> Total Enrolled Patients
                </div>
                <div class="metric-value" style="color: #0dcaf0;">
                    {{ total_patients|default:0 }}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Active participants</small>
                </div>
                <i class="fas fa-users metric-icon" style="color: #0dcaf0;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card metric-card" style="border-left-color: #6f42c1;">
            <div class="card-body position-relative">
                <div class="metric-label">
                    <i class="fas fa-vials me-1"></i> Study Phases
                </div>
                <div class="metric-value" style="color: #6f42c1;">
                    {{ unique_phases|default:0 }}
                </div>
                <div class="mt-2">
                    <small class="text-muted">Different phases</small>
                </div>
                <i class="fas fa-vials metric-icon" style="color: #6f42c1;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Studies Grid -->
<div class="row g-4 mb-4">
    {% for study in studies %}
    <div class="col-lg-6">
        <div class="card h-100 study-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-flask text-primary me-2"></i>
                            {{ study.study_id }}
                        </h5>
                        <p class="text-muted mb-0">{{ study.study_name }}</p>
                    </div>
                    <span class="badge bg-primary-subtle text-primary">
                        Phase {{ study.get_phase_display }}
                    </span>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Protocol Information -->
                <div class="mb-3 p-3 rounded" style="background-color: rgba(13, 110, 253, 0.05);">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-file-medical text-primary me-2 mt-1"></i>
                                <div>
                                    <small class="text-muted d-block">Protocol Number</small>
                                    <strong>{{ study.protocol_number }}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-calendar-alt text-primary me-2 mt-1"></i>
                                <div>
                                    <small class="text-muted d-block">Study Phase</small>
                                    <strong>{{ study.get_phase_display }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div class="text-center p-3 rounded" style="background-color: rgba(25, 135, 84, 0.1);">
                            <div class="fw-bold text-success" style="font-size: 1.5rem;">
                                {{ study.site_count|default:0 }}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-hospital me-1"></i>Research Sites
                            </small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 rounded" style="background-color: rgba(13, 202, 240, 0.1);">
                            <div class="fw-bold" style="color: #0dcaf0; font-size: 1.5rem;">
                                {{ study.patient_count|default:0 }}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>Enrolled Patients
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Study Description (if available) -->
                {% if study.description %}
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ study.description|truncatewords:25 }}
                    </small>
                </div>
                {% endif %}

                <!-- Status Indicator -->
                <div class="mb-3">
                    <span class="status-indicator status-clean">
                        <span class="status-dot"></span>
                        ACTIVE
                    </span>
                </div>
            </div>

            <!-- Card Footer with Actions -->
            <div class="card-footer bg-transparent">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'base:dashboard' %}?study={{ study.id }}" 
                       class="btn btn-primary btn-sm flex-grow-1">
                        <i class="fas fa-chart-line me-1"></i> View Dashboard
                    </a>
                    <a href="{% url 'base:site_list' %}?study={{ study.id }}" 
                       class="btn btn-outline-primary btn-sm flex-grow-1">
                        <i class="fas fa-hospital me-1"></i> View Sites
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-edit me-2"></i>Edit Study
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-file-export me-2"></i>Export Data
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="fas fa-archive me-2"></i>Archive Study
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Studies Available</h4>
                <p class="text-muted mb-4">Get started by adding your first clinical study</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudyModal">
                    <i class="fas fa-plus me-2"></i>Add New Study
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Add any study-specific JavaScript here
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips if needed
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.study-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.study-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
}

.study-card .card-header {
    background-color: rgba(13, 110, 253, 0.03);
    border-bottom: 2px solid rgba(13, 110, 253, 0.1);
}
</style>
{% endblock %}