{% extends 'base/base.html' %}

{% block title %}Site {{ site.site_number }} - NEST 2.0{% endblock %}

{% block content %}
<div class="main-content">

    <!-- Site Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Site {{ site.site_number }} - {{ site.site_name }}</h1>
            <p class="text-muted">{{ site.country }} | {{ site.investigator_name }}</p>
        </div>
        <div>
            <span class="dqi-badge badge dqi-{{ site.get_dqi_status }}">
                DQI: {{ site.dqi_score }}/100
            </span>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6 class="text-uppercase text-muted mb-2">Total Patients</h6>
                <h3>{{ metrics.total_patients }}</h3>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6 class="text-uppercase text-muted mb-2">Clean Patients</h6>
                <h3 class="text-success">{{ metrics.clean_patients }}</h3>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6 class="text-uppercase text-muted mb-2">Open Queries</h6>
                <h3 class="text-warning">{{ metrics.open_queries }}</h3>
                <small class="text-muted">Avg age: {{ metrics.avg_query_age }} days</small>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6 class="text-uppercase text-muted mb-2">Visit Completion</h6>
                <h3 class="text-info">{{ metrics.completion_rate }}%</h3>
            </div></div>
        </div>
    </div>

    <!-- AI Insights & Alerts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot text-primary"></i> AI Insights
                    </h5>
                    <button class="btn btn-sm btn-primary"
                            onclick="generateInsight('summary', this)">
                        <i class="fas fa-magic"></i> Generate Summary
                    </button>
                </div>

                <div class="card-body">

                    <!-- AI Insights -->
                    <div id="aiInsightsContainer">
                        {% for insight in ai_insights %}
                        <div class="mb-3 p-3 bg-light rounded">

                            <div class="d-flex justify-content-between mb-2">
                                <strong class="text-primary">
                                    {{ insight.get_insight_type_display }}
                                </strong>
                                <small class="text-muted">
                                    {{ insight.created_at|timesince }} ago
                                </small>
                            </div>

                            <div class="ai-insight-content">
                                {{ insight.content|linebreaks }}
                            </div>

                        </div>
                        {% empty %}
                        <p class="text-muted">
                            No AI insights generated yet. Click the button above to generate.
                        </p>
                        {% endfor %}
                    </div>

                    <!-- AI Query -->
                    <form id="aiQueryForm" class="mt-4">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="customQuery"
                                   placeholder="Ask a question about this site..."
                                   required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i> Ask AI
                            </button>
                        </div>
                    </form>

                    <div id="aiAnswer" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bell text-warning"></i> Active Alerts
                    </h5>
                </div>
                <div class="card-body" style="max-height:400px;overflow-y:auto;">
                    {% for alert in alerts %}
                    <div class="card mb-2 alert-{{ alert.severity }}">
                        <div class="card-body p-2">
                            <span class="badge bg-{{ alert.severity }}">
                                {{ alert.severity|upper }}
                            </span>
                            <p class="mb-0 mt-1">
                                <small>{{ alert.message }}</small>
                            </p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No active alerts.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- DQI Trend -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <h5><i class="fas fa-chart-line text-success"></i> DQI Score Trend</h5>
        </div>
        <div class="card-body">
            <canvas id="dqiTrendChart"></canvas>
        </div>
    </div>

</div>
<!-- Patients Table -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-users text-info"></i> Patients ({{ patients.count }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Enrollment Date</th>
                            <th>Status</th>
                            <th>Issues</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr>
                            <td><a href="{% url 'base:patient_detail' patient.id %}">{{ patient.patient_id }}</a></td>
                            <td>{{ patient.enrollment_date|default:"N/A" }}</td>
                            <td><span class="badge bg-{{ patient.status }}">{{ patient.get_status_display }}</span></td>
                            <td>{{ patient.issues_count }}</td>
                            <td>
                                <a href="{% url 'base:patient_detail' patient.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- ==================== STYLES ==================== -->
<style>
.ai-insight-content h3,
.ai-insight-content h4 {
    margin-top: 1rem;
    font-weight: 600;
}

.ai-insight-content ul {
    padding-left: 1.2rem;
    margin-bottom: 0.75rem;
}

.ai-insight-content li {
    margin-bottom: 0.4rem;
}

.ai-insight-content p {
    margin-bottom: 0.6rem;
    line-height: 1.5;
}
</style>

<!-- ==================== SCRIPTS ==================== -->
<script>

/* DQI Chart */
let dqiData = [];
try {
    dqiData = JSON.parse('{{ dqi_history|escapejs }}');
} catch {}

if (document.getElementById('dqiTrendChart') && dqiData.length) {
    new Chart(dqiTrendChart.getContext('2d'), {
        type: 'line',
        data: {
            labels: dqiData.map(d => new Date(d.calculated_at).toLocaleDateString()),
            datasets: [{
                label: 'DQI Score',
                data: dqiData.map(d => d.dqi_score),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37,99,235,0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
}

/* Generate Insight */
function generateInsight(type, btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    fetch("{% url 'base:generate_ai_insight' site.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ insight_type: type })
    })
    .then(() => location.reload());
}

/* Ask AI */
document.getElementById('aiQueryForm').addEventListener('submit', e => {
    e.preventDefault();

    const q = customQuery.value.trim();
    if (!q) return;

    aiAnswer.innerHTML =
        '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>';

    fetch("{% url 'base:generate_ai_insight' site.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ custom_query: q })
    })
    .then(r => r.json())
    .then(d => {
        aiAnswer.innerHTML = `
            <div class="alert alert-success ai-insight-content">
                <strong>AI Response</strong><hr class="my-2">
                ${d.content.replace(/\n/g,'<br>')}
            </div>`;
        customQuery.value = '';
    });
});
</script>
{% endblock %}
